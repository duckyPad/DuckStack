// ==========================================
// DuckStack Memory Stress Test
// ==========================================
// TARGET: DuckStack VM 32-bit Little-Endian
// ==========================================

DELAY 1000
STRINGLN =================================
STRINGLN STARTING MEMORY STRESS TEST
STRINGLN =================================

// ------------------------------------------
// HELPER FUNCTION: Assertion
// ------------------------------------------
// Prints PASS if actual == expected, else FAIL
// ------------------------------------------
FUN assert_test(test_id, actual, expected)
    IF actual == expected
        STRINGLN [PASS] Test $test_id: Got $actual (Match)
    ELSE
        STRINGLN [FAIL] Test $test_id: Exp $expected, Got $actual
    END_IF
END_FUN

// ==========================================
// SECTION 1: 8-BIT OPERATIONS (Signed/Unsigned)
// ==========================================
// Testing Region: Scratch Memory (0xF400 / 62464)
// ==========================================

STRINGLN --- 8-BIT READ/WRITE ---

VAR addr_scratch = 0xF400 // 62464

// TEST 1: Write 0xFF (255). 
// Expect: -1 if PEEK8 (Signed), 255 if PEEKU8 (Unsigned)
POKE8(addr_scratch, 255)

VAR res_s8 = PEEK8(addr_scratch)
VAR res_u8 = PEEKU8(addr_scratch)

assert_test(1, res_s8, -1)
assert_test(2, res_u8, 255)

// ==========================================
// SECTION 2: 16-BIT OPERATIONS
// ==========================================

STRINGLN --- 16-BIT READ/WRITE ---

// TEST 3: Write 0xFFFF (65535). 
// Expect: -1 if PEEK16 (Signed), 65535 if PEEKU16 (Unsigned)
POKE16(addr_scratch, 65535)

VAR res_s16 = PEEK16(addr_scratch)
VAR res_u16 = PEEKU16(addr_scratch)

assert_test(3, res_s16, -1)
assert_test(4, res_u16, 65535)

// ==========================================
// SECTION 3: 32-BIT & ENDIANNESS
// ==========================================

STRINGLN --- 32-BIT & ENDIANNESS ---

// TEST 5: Write Magic Number 0xDEADBEEF (Decimal: 3735928559)
// Since vars are signed, this is -559038737
VAR magic_val = -559038737 
POKE32(addr_scratch, magic_val)

VAR read_back = PEEK32(addr_scratch)
assert_test(5, read_back, magic_val)

// TEST 6: Check Little Endian Byte Order
// 0xDEADBEEF in Memory (Little Endian): [EF] [BE] [AD] [DE]
// addr+0 should be 0xEF (239 unsigned, -17 signed)
// addr+3 should be 0xDE (222 unsigned, -34 signed)

VAR byte_0 = PEEKU8(addr_scratch)
VAR byte_3 = PEEKU8(addr_scratch + 3)

// 0xEF = 239
assert_test(6, byte_0, 239) 
// 0xDE = 222
assert_test(7, byte_3, 222) 

// ==========================================
// SECTION 4: MEMORY REGION CROSS-CHECK
// ==========================================
// Validating access to distinct memory regions
// ==========================================

STRINGLN --- MEMORY REGIONS ---

// Region: User Globals (0xF000 / 61440)
VAR addr_usr_global = 0xF000

// Region: Persistent Globals (0xFC00 / 64512)
// Corresponds to reserved var _GV0
VAR addr_pers_global = 0xFC00

// TEST 8: Write different values to different regions
POKE32(addr_usr_global, 11111)
POKE32(addr_pers_global, 22222)

VAR val_usr = PEEK32(addr_usr_global)
VAR val_pers = PEEK32(addr_pers_global)

assert_test(8, val_usr, 11111)
assert_test(9, val_pers, 22222)

// ==========================================
// SECTION 5: RESERVED VARIABLE MAPPING
// ==========================================
// Testing if _GV0 points to 0xFC00
// ==========================================

STRINGLN --- RESERVED VAR MAPPING ---

// TEST 10: Read _GV0. It should hold 22222 from Test 8
// Because _GV0 is mapped to 0xFC00
VAR gv0_val = _GV0
assert_test(10, gv0_val, 22222)

// TEST 11: Modify _GV1 via Variable, Read via PEEK
// _GV1 is at 0xFC04 (0xFC00 + 4 bytes)
_GV1 = 33333
VAR gv1_peek = PEEK32(0xFC04)
assert_test(11, gv1_peek, 33333)

// ==========================================
// SECTION 6: DISALLOWED / RESERVED REGION
// ==========================================
// Region: 0xF800 - 0xFBFF is listed as "Reserved"
// ==========================================

STRINGLN --- RESERVED REGION TEST ---

VAR addr_reserved = 0xF800

// TEST 12: Attempt Write to Reserved Region
// NOTE: Behavior depends on VM implementation. 
// If strict, this might crash. If loose, it stores data.
// We write, then try to read back.

POKE32(addr_reserved, 99999)
VAR res_val = PEEK32(addr_reserved)

// If this prints 99999, the VM allows writing to reserved space.
// If it prints 0 or garbage, the memory is protected/disconnected.
STRINGLN [INFO] Write Reserved (0xF800):
STRINGLN    > Wrote: 99999
STRING    > Read:  
STRINGLN $res_val

STRINGLN =================================
STRINGLN TEST COMPLETE
STRINGLN =================================