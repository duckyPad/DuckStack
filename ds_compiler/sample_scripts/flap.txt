DEFINE OLED_WIDTH 128
DEFINE OLED_HEIGHT 128

DEFINE SCALE_FACTOR 10
DEFINE GRAVITY 3
DEFINE JUMP_STRENGTH -30

DEFINE BIRD_START_X 20
DEFINE BIRD_START_Y 60
DEFINE BIRD_RADIUS 3

DEFINE FRAME_DELAY 25

// ------ bird ------
VAR bird_velocity_y = 0 
VAR bird_y_scaled = BIRD_START_Y * SCALE_FACTOR

// ------- walls -------
DEFINE WALL_THICKNESS_PIXELS 6
VAR wall_1_x_scaled = 0

// SPEED CONTROL:
// 15 = 1.5 pixels per frame
// 20 = 2.0 pixels per frame
// 8  = 0.8 pixels per frame
VAR wall_scroll_speed_scaled = 15

DEFINE WALL_START_POS_X 150

FUN debug_reset()
    bird_y_scaled = BIRD_START_Y * SCALE_FACTOR
    bird_velocity_y = 0
    // Reset wall to start on death/reset
    // wall_1_x_scaled = WALL_START_POS_X * SCALE_FACTOR
END_FUN

FUN wall_init()
    // Initialize wall position in Scaled Units
    wall_1_x_scaled = WALL_START_POS_X * SCALE_FACTOR
END_FUN

FUN draw_wall(left_edge_pos)
    VAR right_edge_pos = left_edge_pos + WALL_THICKNESS_PIXELS
    
    // Bounds checking to prevent drawing off-screen (which might wrap or error)
    IF left_edge_pos >= 0
        pass
    ELSE IF left_edge_pos >= -WALL_THICKNESS_PIXELS
        left_edge_pos = 0
    ELSE
        RETURN
    END_IF
    
    IF right_edge_pos < OLED_WIDTH
        pass
    ELSE IF right_edge_pos < OLED_WIDTH + WALL_THICKNESS_PIXELS
        right_edge_pos = OLED_WIDTH-1
    ELSE
        RETURN
    END_IF
    
    OLED_RECT left_edge_pos 0 right_edge_pos OLED_HEIGHT 1
END_FUN

FUN wall_update()
    // Move the wall by the scaled speed
    wall_1_x_scaled -= wall_scroll_speed_scaled
    
    // Check reset threshold using Scaled Units
    // Threshold is: -1 * Thickness * Scale
    VAR reset_threshold_scaled = -1 * WALL_THICKNESS_PIXELS
    reset_threshold_scaled *= SCALE_FACTOR

    IF wall_1_x_scaled <= reset_threshold_scaled
        wall_1_x_scaled = WALL_START_POS_X * SCALE_FACTOR
    END_IF

    // Convert to real pixels for drawing
    VAR draw_x = wall_1_x_scaled / SCALE_FACTOR
    draw_wall(draw_x)
END_FUN

wall_init()

WHILE 1
    // Input handling
    VAR key = _READKEY
    IF key > 0
        bird_velocity_y = JUMP_STRENGTH
    END_IF

    OLED_CLEAR
    // Draw floor/ceiling
    OLED_LINE 0 0 127 0
    OLED_LINE 0 127 127 127
    
    // Calculate bird draw position
    VAR bird_draw_y = bird_y_scaled / SCALE_FACTOR
    VAR max_height_scaled = OLED_HEIGHT * SCALE_FACTOR
    
    // Collision/Reset logic
    IF (bird_draw_y <= (BIRD_RADIUS*2)) || (bird_y_scaled >= max_height_scaled)
        debug_reset()
    END_IF
    
    OLED_CIRCLE BIRD_START_X bird_draw_y BIRD_RADIUS 1
    
    // Update and draw walls
    wall_update()
    
    OLED_UPDATE
    
    // Physics update
    bird_velocity_y = bird_velocity_y + GRAVITY
    bird_y_scaled = bird_y_scaled + bird_velocity_y

    DELAY FRAME_DELAY
END_WHILE
