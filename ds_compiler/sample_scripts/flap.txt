DEFINE SCRATCH_MEM_START 0xf400
DEFINE OLED_WIDTH 128
DEFINE OLED_HEIGHT 128

DEFINE SCALE_FACTOR 10
DEFINE GRAVITY 3
DEFINE JUMP_STRENGTH -30

DEFINE BIRD_START_X 20
DEFINE BIRD_START_Y 60
DEFINE BIRD_RADIUS 3

DEFINE FRAME_DELAY 30

// ------ bird ------
VAR bird_velocity_y = 0 
VAR bird_y_scaled = BIRD_START_Y * SCALE_FACTOR

// ------- walls -------
DEFINE WALL_THICKNESS_PIXELS 6
VAR wall_1_x_pos = 0
VAR wall_scroll_speed_pixel_per_frame = 2

DEFINE WALL_START_POS_X 150

FUN debug_reset()
    bird_y_scaled = BIRD_START_Y * SCALE_FACTOR
    bird_velocity_y = 0
END_FUN

FUN wall_init()
    wall_1_x_pos = WALL_START_POS_X
END_FUN

FUN draw_wall(left_edge_pos)
    VAR right_edge_pos = left_edge_pos + WALL_THICKNESS_PIXELS
    IF left_edge_pos >= 0
        pass
    ELSE IF left_edge_pos >= -WALL_THICKNESS_PIXELS
        left_edge_pos = 0
    ELSE
        RETURN
    END_IF
    IF right_edge_pos < OLED_WIDTH
        pass
    ELSE IF right_edge_pos < OLED_WIDTH + WALL_THICKNESS_PIXELS
        right_edge_pos = OLED_WIDTH-1
    ELSE
        RETURN
    END_IF
    OLED_RECT left_edge_pos 0 right_edge_pos OLED_HEIGHT 1
END_FUN

FUN wall_update()
    wall_1_x_pos -= wall_scroll_speed_pixel_per_frame
    IF wall_1_x_pos <= -1 * WALL_THICKNESS_PIXELS
        wall_1_x_pos = WALL_START_POS_X
    END_IF
    draw_wall(wall_1_x_pos)
END_FUN

wall_init()

WHILE 1
    IF _READKEY > 0
        bird_velocity_y = JUMP_STRENGTH
    END_IF

    OLED_CLEAR
    OLED_LINE 0 0 127 0
    OLED_LINE 0 127 127 127
    VAR draw_y = bird_y_scaled / SCALE_FACTOR
    
    IF (draw_y <= (BIRD_RADIUS*2)) || (bird_y_scaled >= max_height)
        debug_reset()
    END_IF
    
    OLED_CIRCLE BIRD_START_X draw_y BIRD_RADIUS 1
    wall_update()
    OLED_UPDATE
    
    bird_velocity_y = bird_velocity_y + GRAVITY
    bird_y_scaled = bird_y_scaled + bird_velocity_y
    VAR max_height = OLED_HEIGHT * SCALE_FACTOR
    
    DELAY FRAME_DELAY
END_WHILE