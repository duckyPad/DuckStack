DEFINE OLED_WIDTH 128
DEFINE OLED_HEIGHT 128
DEFINE SCALE_FACTOR 10
DEFINE GRAVITY 3
DEFINE JUMP_STRENGTH -30
DEFINE FRAME_DELAY 25

// ------ bird ------
DEFINE BIRD_START_X 20
DEFINE BIRD_START_Y 60
DEFINE BIRD_RADIUS 3
VAR bird_velocity_y = 0 
VAR bird_y_scaled = BIRD_START_Y * SCALE_FACTOR

// ------- walls -------
DEFINE WALL_THICKNESS_PIXELS 6
// off screen
DEFINE WALL_START_POS_X 150
DEFINE DEFAULT_WALL_SPACING 40
DEFINE WALL_RESET_THRESHOLD_SCALED (-1 * WALL_THICKNESS_PIXELS * SCALE_FACTOR)
DEFINE WALL_SPACING_VARIANCE_PIXELS 5
DEFINE DEFAULT_WALL_GAP_SIZE 40
DEFINE DEFAULT_WALL_Y (OLED_HEIGHT/2)

VAR wall_scroll_speed_scaled = 15

VAR wall_1_x_scaled = 0
VAR wall_1_gap_y = DEFAULT_WALL_Y
VAR wall_1_gap_size = DEFAULT_WALL_GAP_SIZE

VAR wall_2_x_scaled = 0
VAR wall_2_gap_y = DEFAULT_WALL_Y
VAR wall_2_gap_size = DEFAULT_WALL_GAP_SIZE

VAR wall_3_x_scaled = 0
VAR wall_3_gap_y = DEFAULT_WALL_Y
VAR wall_3_gap_size = DEFAULT_WALL_GAP_SIZE

VAR wall_4_x_scaled = 0
VAR wall_4_gap_y = DEFAULT_WALL_Y
VAR wall_4_gap_size = DEFAULT_WALL_GAP_SIZE

FUN debug_reset()
    bird_y_scaled = BIRD_START_Y * SCALE_FACTOR
    bird_velocity_y = 0
    // Reset wall to start on death/reset
    // wall_1_x_scaled = WALL_START_POS_X * SCALE_FACTOR
END_FUN

FUN wall_init()
    // Initialize wall position in Scaled Units
    wall_1_x_scaled = WALL_START_POS_X * SCALE_FACTOR
    wall_2_x_scaled = wall_1_x_scaled + DEFAULT_WALL_SPACING * SCALE_FACTOR
    wall_3_x_scaled = wall_2_x_scaled + DEFAULT_WALL_SPACING * SCALE_FACTOR
    wall_4_x_scaled = wall_3_x_scaled + DEFAULT_WALL_SPACING * SCALE_FACTOR
    shuffle_wall_gap()
END_FUN

FUN draw_wall(left_edge_pos, wall_gap_y_lower, wall_gap_size)
    VAR right_edge_pos = left_edge_pos + WALL_THICKNESS_PIXELS
    
    // Bounds checking to prevent drawing off-screen (which might wrap or error)
    IF left_edge_pos >= 0
        pass
    ELSE IF left_edge_pos >= -WALL_THICKNESS_PIXELS
        left_edge_pos = 0
    ELSE
        RETURN
    END_IF
    
    IF right_edge_pos < OLED_WIDTH
        pass
    ELSE IF right_edge_pos < OLED_WIDTH + WALL_THICKNESS_PIXELS
        right_edge_pos = OLED_WIDTH-1
    ELSE
        RETURN
    END_IF
    
    OLED_RECT left_edge_pos OLED_HEIGHT right_edge_pos wall_gap_y_lower 1
    OLED_RECT left_edge_pos wall_gap_y_lower-wall_gap_size right_edge_pos 0 1
END_FUN

FUN shuffle_wall_gap()
    wall_1_gap_y = RANDINT(WALL_GAP_SIZE_MIN, WALL_GAP_SIZE_MAX)
    wall_2_gap_y = RANDINT(WALL_GAP_SIZE_MIN, WALL_GAP_SIZE_MAX)
    wall_3_gap_y = RANDINT(WALL_GAP_SIZE_MIN, WALL_GAP_SIZE_MAX)
    wall_4_gap_y = RANDINT(WALL_GAP_SIZE_MIN, WALL_GAP_SIZE_MAX)
    wall_1_gap_y = RANDINT(WALL_GAP_Y_LOWER_POS_MIN, WALL_GAP_Y_LOWER_POS_MAX)
    wall_2_gap_y = RANDINT(WALL_GAP_Y_LOWER_POS_MIN, WALL_GAP_Y_LOWER_POS_MAX)
    wall_3_gap_y = RANDINT(WALL_GAP_Y_LOWER_POS_MIN, WALL_GAP_Y_LOWER_POS_MAX)
    wall_4_gap_y = RANDINT(WALL_GAP_Y_LOWER_POS_MIN, WALL_GAP_Y_LOWER_POS_MAX)
END_FUN

FUN move_wall(wall_x_scaled)
    wall_x_scaled -= wall_scroll_speed_scaled
    IF wall_x_scaled <= WALL_RESET_THRESHOLD_SCALED
        shuffle_wall_gap()
        RETURN (WALL_START_POS_X + RANDINT(-WALL_SPACING_VARIANCE_PIXELS, WALL_SPACING_VARIANCE_PIXELS)) * SCALE_FACTOR
    END_IF
    RETURN wall_x_scaled
END_FUN

DEFINE WALL_GAP_SIZE_MIN 30
DEFINE WALL_GAP_SIZE_MAX 50
DEFINE WALL_GAP_Y_LOWER_POS_MIN (WALL_GAP_SIZE_MAX+5)
DEFINE WALL_GAP_Y_LOWER_POS_MAX (OLED_HEIGHT-1)

FUN wall_update()
    wall_1_x_scaled = move_wall(wall_1_x_scaled)
    wall_2_x_scaled = move_wall(wall_2_x_scaled)
    wall_3_x_scaled = move_wall(wall_3_x_scaled)
    wall_4_x_scaled = move_wall(wall_4_x_scaled)
    draw_wall(wall_1_x_scaled / SCALE_FACTOR, wall_1_gap_y, wall_1_gap_size)
    draw_wall(wall_2_x_scaled / SCALE_FACTOR, wall_2_gap_y, wall_2_gap_size)
    draw_wall(wall_3_x_scaled / SCALE_FACTOR, wall_3_gap_y, wall_3_gap_size)
    draw_wall(wall_4_x_scaled / SCALE_FACTOR, wall_4_gap_y, wall_4_gap_size)
END_FUN

wall_init()

WHILE 1
    // Input handling
    VAR key = _READKEY
    IF key > 0
        bird_velocity_y = JUMP_STRENGTH
    END_IF

    OLED_CLEAR
    // Draw floor/ceiling
    OLED_LINE 0 0 127 0
    OLED_LINE 0 127 127 127
    
    // Calculate bird draw position
    VAR bird_draw_y = bird_y_scaled / SCALE_FACTOR
    VAR max_height_scaled = OLED_HEIGHT * SCALE_FACTOR
    
    // Collision/Reset logic
    IF (bird_draw_y <= (BIRD_RADIUS*2)) || (bird_y_scaled >= max_height_scaled)
        debug_reset()
    END_IF
    
    OLED_CIRCLE BIRD_START_X bird_draw_y BIRD_RADIUS 1
    
    // Update and draw walls
    wall_update()
    
    OLED_UPDATE
    
    // Physics update
    bird_velocity_y = bird_velocity_y + GRAVITY
    bird_y_scaled = bird_y_scaled + bird_velocity_y

    DELAY FRAME_DELAY
END_WHILE
