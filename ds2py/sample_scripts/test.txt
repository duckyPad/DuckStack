REM_BLOCK
    DuckStack Compiler Stress Test
    Target: Bytecode VM generation
    Includes: Recursion, Math, Hardware, Scope
END_REM

// 1. Constants and Globals
DEFINE MAX_LOOPS 3
VAR result = 0
VAR counter = 0
VAR shadow_test = 999 

// 2. Function Definition: Recursive Factorial
// Tests: Stack frames, CALL, RET, Argument passing
FUNCTION factorial(n)
    // Base case
    IF n <= 1 THEN
        RETURN 1
    END_IF
    
    // Recursive step
    // Note: Creating a local var to test local stack allocation
    VAR prev_step = 0
    VAR val_minus_one = n - 1
    
    prev_step = factorial(val_minus_one)
    
    // Return result (Expression on return)
    RETURN n * prev_step
END_FUNCTION

// 3. Function: Variable Shadowing & Hardware
FUNCTION hardware_check(arg1)
    // 'shadow_test' here should be LOCAL, distinct from GLOBAL 999
    VAR shadow_test = 50 
    
    // Move mouse (tests negative numbers and hardware opcodes)
    MOUSE_MOVE 10 -10
    DELAY 100
    
    // OLED Graphics
    OLED_CLEAR
    OLED_RECT 1 0 0 32 32
    OLED_UPDATE
    
    RETURN shadow_test + arg1
END_FUNCTION

// --- MAIN EXECUTION START ---

STRINGLN Starting Stress Test...

// 4. Test Arithmetic & Bitwise Logic
// (5 * 2) + (8 >> 2) = 10 + 2 = 12
VAR math_check = (5 * 2) + (8 >> 2) 
STRINGLN Math Check (Expect 12): $math_check

// 5. Loop & Control Flow
WHILE counter < MAX_LOOPS
    STRINGLN Loop Index: $counter

    // Test Recursion
    // Calculate Factorial of (counter + 1)
    VAR f_input = counter + 1
    result = factorial(f_input)
    STRINGLN Factorial Result: $result

    // Test Logic Operators
    IF (counter & 1) == 0 THEN
        STRINGLN Status: Even
    END_IF
    
    IF (counter & 1) != 0 THEN
        STRINGLN Status: Odd
    END_IF

    counter = counter + 1
END_WHILE

// 6. Test Shadowing
VAR hw_result = 0
hw_result = hardware_check(10)

STRINGLN Local Shadow Result (Expect 60): $hw_result
STRINGLN Global Shadow Var (Expect 999): $shadow_test

STRINGLN Test Complete.