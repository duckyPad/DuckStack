REM_BLOCK
    DuckyScript Compiler Workout
    This script tests: 
    1. Preprocessor (DEFINES)
    2. Scoping (Global vs Local)
    3. Recursion & Stack Frames
    4. Bitwise & Logical Operators
    5. Advanced Printing & Formatting
    6. Hardware I/O (Mouse/Keyboard/OLED)
END_REM

// --- 1. Preprocessor & Constants ---
DEFINE VERSION 1
DEFINE TARGET_VAL 10
DEFINE BIT_MASK 0x0F // Preprocessor replaces as-is

// --- 2. Variables & Scoping ---
VAR g_check = 0
VAR g_loop_count = 5
_GV0 = 42 // Persistent global test

// --- 3. The Recursive Function (Tests CALL, RET, ALLOC, and Stack Offsets) ---
FUNCTION FACTORIAL(n)
    VAR local_res = 1
    IF n <= 1 THEN
        RETURN 1
    END_IF
    
    // Test recursive call and complex expression return
    local_res = n * FACTORIAL(n - 1)
    RETURN local_res
END_FUNCTION

// --- 4. Logic and Expression Evaluation ---
FUNCTION MATH_TEST(a, b)
    // Tests bitwise, logical, and arithmetic precedence
    VAR result = ((a << 2) | (b >> 1)) ^ BIT_MASK
    IF (a > b && b != 0) || !g_check THEN
        result = result + (a % b)
    END_IF
    RETURN result
END_FUNCTION

// --- 5. Main Execution Flow ---

// Test Delay and Special Keys
DELAY 500
WINDOWS r
DELAY 200
STRINGLN notepad
DELAY 500

// Test Advanced Printing & Formatting
_STR_PRINT_FORMAT = 3 // Hex Upper Case
_STR_PRINT_PADDING = 4
VAR fact_result = FACTORIAL(5)

STRINGLN --- Compiler Test vVERSION ---
STRINGLN Factorial of 5 (Hex): $fact_result

// Test Loops and LBREAK/CONTINUE
VAR i = 0
WHILE i < g_loop_count
    i = i + 1
    IF i == 2 THEN
        CONTINUE
    END_IF
    
    STRING Counter is at: $i
    STRINGLN (skipping 2...)
    
    IF i >= 4 THEN
        LBREAK
    END_IF
END_WHILE

// --- 6. Hardware & Mouse Interaction ---
MOUSE_MOVE 100 100
MOUSE_WHEEL -2
KEYDOWN ALT
TAB
KEYUP ALT

// Randomization test
_RANDOM_MIN = 1
_RANDOM_MAX = 100
VAR rand_val = _RANDOM_INT
STRINGLN Random Value: $rand_val

// --- 7. Final State Check ---
IF g_check == 0 THEN
    STRINGLN TEST PASSED
ELSE
    STRINGLN TEST FAILED
END_IF

HALT