REM_BLOCK
    DuckStack Compiler Torture Test
    Target: 32-bit VM
    Features: Recursion, Bitwise, Scoping, IO, Math modes
END_REM

// ==========================================
// 1. Preprocessor & Constants
// ==========================================
DEFINE MAX_COUNT 5
DEFINE TARGET_EMAIL admin@example.com

// ==========================================
// 2. Global Variable Initialization
// ==========================================
VAR g_counter = 0
VAR g_result = 0
VAR g_shadow_me = 9999
VAR g_flags = 0

// ==========================================
// 3. Function Definitions
// ==========================================

// Function 1: Math & Local Scoping
// Tests argument passing and local variable shadowing
FUNCTION math_calc(a, b)
    VAR local_res = 0
    
    // Complex expression order of operations
    local_res = (a * 2) + (b / 2) - (a % 3)
    
    // Test Shadowing: This should NOT affect g_shadow_me
    VAR g_shadow_me = 1 
    local_res = local_res + g_shadow_me
    
    RETURN local_res
END_FUNCTION

// Function 2: Recursion
// Tests stack frame management (ALLOC, CALL, RET)
FUNCTION factorial(n)
    IF n <= 1 THEN
        RETURN 1
    END_IF
    
    VAR temp = 0
    // Recursive call
    temp = factorial(n - 1)
    
    RETURN n * temp
END_FUNCTION

// ==========================================
// 4. Main Execution Logic
// ==========================================

STRINGLN_BLOCK
Starting System Test...
Checking Math...
END_STRINGLN

// --- Math & Function Call Test ---
// Expected: (10*2) + (20/2) - (10%3) + 1 = 20 + 10 - 1 + 1 = 30
g_result = math_calc(10, 20)

IF g_result == 30 THEN
    STRINGLN [PASS] Math & Scoping
ELSE
    STRINGLN [FAIL] Math & Scoping: Got $g_result
END_IF

// --- Global Variable Integrity Test ---
IF g_shadow_me == 9999 THEN
    STRINGLN [PASS] Global Shadowing Integrity
ELSE
    STRINGLN [FAIL] Global Shadowing: Var clobbered!
END_IF

// --- Recursion Test ---
// Factorial of 5 = 120
g_result = factorial(MAX_COUNT) 
STRINGLN Factorial of MAX_COUNT is: $g_result

// --- Bitwise & Logic Operations ---
// Test shifts and logical operators
VAR bit_val = 1
bit_val = bit_val << 4      // 16
bit_val = bit_val | 1       // 17 (0001 0001)
bit_val = bit_val & 240     // 17 & 1111 0000 = 16

IF bit_val == 16 && g_shadow_me > 0 THEN
    STRINGLN [PASS] Bitwise Logic
END_IF

// --- Loop & Control Flow ---
STRINGLN Starting Loop Test...
VAR i = 0
WHILE TRUE
    i = i + 1
    
    // Test CONTINUE
    IF i == 2 THEN
        STRINGLN - Skipping 2
        CONTINUE
    END_IF
    
    STRINGLN - Count: $i
    
    // Test LBREAK
    IF i >= 4 THEN
        LBREAK
    END_IF
END_WHILE

// --- Hardware & IO Stress ---
STRINGLN Testing IO...

// Mouse geometry
MOUSE_MOVE 100 -50
DELAY 100
MOUSE_MOVE -100 50
MOUSE_WHEEL 2

// Key combos
KEYDOWN CTRL
STRING c
KEYUP CTRL

// OLED Graphics (if supported by hardware)
OLED_CLEAR
OLED_RECT 1 0 0 32 32
OLED_CIRCLE 0 5 16 16
OLED_PRINT Done.
OLED_UPDATE

// --- Formatting & VM Settings ---
// Test Hex printing
_STR_PRINT_FORMAT = 3 // Hex Uppercase
_STR_PRINT_PADDING = 4
STRINGLN Hex check (Should be 001E): $g_result

// Test Unsigned Math Toggle
_UNSIGNED_MATH = 1
VAR neg_check = 0 - 1
STRINGLN Unsigned -1 is: $neg_check
_UNSIGNED_MATH = 0

STRINGLN_BLOCK
Test Complete.
Sending Report to TARGET_EMAIL...
END_STRINGLN